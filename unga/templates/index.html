<!doctype html>
<html>
  <head>
    <title>Unga</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css">
    <script type="text/javascript">
    (function() {
      var po = document.createElement('script');
      po.type = 'text/javascript'; po.async = true;
      po.src = 'https://plus.google.com/js/client:plusone.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(po, s);
    })();
    </script>
  </head>
  <body>
    <h1>Unga</h1>
    <div id="gConnect">
      <button class="g-signin"
          data-scope="https://www.googleapis.com/auth/plus.login openid"
          data-requestvisibleactions="http://schemas.google.com/AddActivity"
          data-clientId="793850702446.apps.googleusercontent.com"
          data-callback="onSignInCallback"
          data-theme="dark"
          data-cookiepolicy="single_host_origin">
      </button>
    </div>
    <div id="result" style="display:none">
      <button id="disconnect" >Disconnect your Google account from this app</button>
      <pre id="authResult"></pre>
      <pre id="ungaAuthResult"></pre>
    </div>

    <script src="//code.jquery.com/jquery.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        $('#disconnect').click(disconnect);
      });

      function onSignInCallback(authResult) {
        $('#result').show();
        $('#authResult').html('Auth Result:<br/>');
        for (var field in authResult) {
          $('#authResult').append(' ' + field + ': ' +
              authResult[field] + '<br/>');
        }
        if (authResult['access_token']) {
          $('#gConnect').hide();
          authenticateUnga(authResult['id_token']);
        } else if (authResult['error']) {
          console.log('There was an error: ' + authResult['error']);
          $('#authResult').append('Logged out');
          $('#gConnect').show();
        }
        console.log('authResult', authResult);
      }

      function disconnect() {
        // Revoke the access token.
        $.ajax({
          type: 'GET',
          url: 'https://accounts.google.com/o/oauth2/revoke?token=' +
              gapi.auth.getToken().access_token,
          async: false,
          contentType: 'application/json',
          dataType: 'jsonp',
          success: function(result) {
            console.log('revoke response: ' + result);
            $('#authOps').hide();
            $('#profile').empty();
            $('#visiblePeople').empty();
            $('#authResult').empty();
            $('#gConnect').show();
          },
          error: function(e) {
            console.log(e);
          }
        });
      }

      function authenticateUnga(idToken) {
        console.log('id_token: ', idToken);
        $.ajax({
          type: 'POST',
          url: 'http://localhost:8000/v1/auth/token',
          data: {
            'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
            'client_id': '793850702446.apps.googleusercontent.com',
            'assertion': idToken
          },
          dataType: 'json',
          success: function(result) {
            $('#ungaAuthResult').html('Unga Auth Result:<br/>');
            for (var field in result) {
              $('#ungaAuthResult').append(' ' + field + ': ' +
                  result[field] + '<br/>');
            }
          },
          error: function(error) {
            $('#ungaAuthResult').html('Unga Auth Result: Error');
            console.log(error);
          }
        });
      }
    </script>
  </body>
</html>
