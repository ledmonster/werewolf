<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>みんなの人狼</title>
    <link href="//netdna.bootstrapcdn.com/bootswatch/3.0.0/slate/bootstrap.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="/static/css/sticky-footer-navbar.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="../../assets/js/html5shiv.js"></script>
      <script src="../../assets/js/respond.min.js"></script>
    <![endif]-->

    <script type="text/javascript">
    (function() {
      var po = document.createElement('script');
      po.type = 'text/javascript'; po.async = true;
      po.src = 'https://plus.google.com/js/client:plusone.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(po, s);
    })();
    </script>
  </head>
  <body>

    <!-- Wrap all page content here -->
    <div id="wrap">

      <!-- Fixed navbar -->
      <nav class="navbar navbar-default navbar-fixed-top" role="navigation">

          <a href="https://git.gree-dev.net/junya-hayashi/werewolf"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_orange_ff7600.png" alt="Fork me on GitHub"></a>
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">みんなの人狼</a>
          </div>

          <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
              <li><a href="/village/list">村一覧</a></li>
            </ul>

            <form class="navbar-form navbar-left">
              <button id="disconnect" style="display:none" class="btn btn-default navbar-btn">Logout</button>
            </form>
          </div>
      </nav>

      <!-- Begin page content -->
      <div class="container">
        <div class="page-header">
          <h1>みんなの人狼</h1>
        </div>
        <p>
          みんなの人狼へようこそ。<a href="/village/list">村のみんなに会いに行きましょう。</a>
        </p>
        <div id="gConnect">
          <button class="g-signin"
              data-scope="https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/userinfo.profile openid email"
              data-requestvisibleactions="http://schemas.google.com/AddActivity"
              data-clientId="793850702446.apps.googleusercontent.com"
              data-callback="onSignInCallback"
              data-theme="dark"
              data-cookiepolicy="single_host_origin">
          </button>
        </div>
        <div id="result" style="display:none">
          <pre id="authResult"></pre>
          <pre id="werewolfAuthResult"></pre>
        </div>
      </div>
    </div>

    <div id="footer">
      <div class="container">
        <p class="text-muted credit">Junya Hayashi 2013.</p>.
      </div>
    </div>



    <script src="//code.jquery.com/jquery.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function() {
        $('#disconnect').click(disconnect);
      });

      function onSignInCallback(authResult) {
        $('#result').show();
        $('#authResult').html('Auth Result:<br/>');
        for (var field in authResult) {
          $('#authResult').append(' ' + field + ': ' +
              authResult[field] + '<br/>');
        }
        if (authResult['access_token']) {
          $('#gConnect').hide();
          authenticateWerewolf(authResult['id_token']);
          $('#disconnect').show();
        } else if (authResult['error']) {
          console.log('There was an error: ' + authResult['error']);
          $('#authResult').append('Logged out');
          $('#gConnect').show();
        }
        console.log('authResult', authResult);
      }

      function disconnect() {
        // Revoke the access token.
        $.ajax({
          type: 'GET',
          url: 'https://accounts.google.com/o/oauth2/revoke?token=' +
              gapi.auth.getToken().access_token,
          async: false,
          contentType: 'application/json',
          dataType: 'jsonp',
          success: function(result) {
            console.log('revoke response: ' + result);
            $('#authOps').hide();
            $('#profile').empty();
            $('#visiblePeople').empty();
            $('#authResult').empty();
            $('#gConnect').show();
            $('#disconnect').hide();
          },
          error: function(e) {
            console.log(e);
          }
        });
      }

      function authenticateWerewolf(idToken) {
        console.log('id_token: ', idToken);
        $.ajax({
          type: 'POST',
          url: 'http://localhost:8000/v1/auth/token',
          data: {
            'grant_type': 'urn:ietf:params:oauth:grant-type:jwt-bearer',
            'client_id': '793850702446.apps.googleusercontent.com',
            'assertion': idToken
          },
          dataType: 'json',
          success: function(result) {
            $('#werewolfAuthResult').html('Werewolf Auth Result:<br/>');
            for (var field in result) {
              $('#werewolfAuthResult').append(' ' + field + ': ' +
                  result[field] + '<br/>');
            }
          },
          error: function(error) {
            $('#werewolfAuthResult').html('Werewolf Auth Result: Error');
            console.log(error);
          }
        });
      }
    </script>
  </body>
</html>
